<div class="card mx-3 w-100">
    <div class="card-header d-block">
        <div class="d-flex align-items-center">
            <input class='btn btn-primary me-2' type="button" id="btnStart" onclick="btnStart()" value="Start"/>
            <input class='btn btn-primary me-2' type="button" id="btnStop" onclick="btnStop()" value="Stop">
            <input class='btn btn-primary me-2' type="button" id="btnClear" onclick="btnClear()" value="Clear">

            <label class="me-2" for="txtRate" >Polling delay (s):</label>
            <input class='me-2' type="text" id="txtRate" onchange="txtRate()" value="0.5" style="width: 3rem">

            <label class="me-2" for="txtLength" >Chart window (s):</label>
            <input class="me-2" type="text" id="txtLength" onchange="txtLength()" value="60" style="width: 3rem">


            <label class="me-2" for="chkGraphs">Graphs:</label>
            <input class="me-auto" type="checkbox" id="chkGraphs" checked="true">

            <a id='aSaveLog'>
                <input class="btn btn-primary me-2" type="button" id="btnSaveLog" value="Download log" disabled>
            </a>

            <input class="btn btn-primary" type="button" id="btnBack" value="Back" onclick="btnStop(); navCard('/templates/card/selectsensors.html')"/>
        </div>
    </div>
    <div class="card-body">
        <h4>Live Data</h4>

        {% if sensors|length > 0 %}
{#        {% if sensors|length == 1 %}#}
        <div class="justify-content-center row sensorList">
{#        {% elif sensors|length == 2 %}#}
{#        <div class="justify-content-center row row-cols-sm-1 row-cols-md-2 sensorList">#}
{#        {% elif sensors|length == 2 %}#}
{#        <div class="justify-content-center row row-cols-sm-1 row-cols-md-2 row-cols-xl-3 sensorList">#}
{#        {% endif %}#}
            {% for sensor in sensors %}
            <div class="col">
                <div class="d-flex pb-2">
                    <div>{{sensor['desc']}}</div>
                    <div class="ms-auto" id="val_{{ sensor['pid'] }}">N/A</div>
                    <div>&nbsp;{{ sensor['unit'] }}</div>
                </div>
                <canvas id="chart_{{sensor['pid']}}" class="Chart" ></canvas>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No sensors could be loaded. Check the vehicle connection and try again.</p>
        {% endif %}


    </div>
</div>

<script>
    var charts = {};
    var dataLog = {};
    var rate;

    // get a JSON list of the sensors to read
    var sensors = {{ sensors|tojson }};

    // initialize each chart
    for (var sensor of sensors) {
        dataLog[sensor.pid] = [];
        charts[sensor.pid] =
            CreateChart(
                $('#chart_' + sensor.pid),
                //!! need to adjust range depending on sensor
                sensor.min, sensor.max
            )
        ;
    }

    function btnStart() {
        socketio.emit('log_start')
        wasRunning = true;
    }

    function btnStop() {
        socketio.emit('log_stop')
        wasRunning = false;
    }

    function btnClear() {
        clearCharts(charts);
    }

    // validate the logging rate text box and send an event if it succeeds
    function txtRate() {
        // socketio.emit('log_rate', $('#txtRate').val())
        checkTxt('#txtRate', 'float', (val) => {
            socketio.emit('log_rate', val);
            rate = val;
        })
    }

    // validate the graph length text box and change the local variable if it succeeds
    function txtLength() {
        // maxPoints = $('#txtLength').val()
        checkTxt('#txtLength', 'float', (seconds) => {
            var val = seconds / rate;

            // limit the value
            if (val > maxData) {
                val = maxData;
                seconds = val * rate;
            }

            // overwrite the value entered
            // for example, if they enter "40.5", it gets truncated to "40" by parseInt()
            $('#txtLength').val(seconds);

            for (sensor of sensors) {
                resizeChart(charts[sensor.pid], val, dataLog[sensor.pid])
            }

            maxPoints = val;
            //resizeCharts(charts, val);
        })
    }

    var sensorList = $('.sensorList');

    $('#chkGraphs').click(function(event){
        // hide the graphs
        $('.Chart').prop('hidden', !this.checked);
        // append/remove the row-cols-1 class, which limits the display without the graphs to 1 column on small devices
        // weird stuff happens otherwise
        sensorList.toggleClass('row-cols-1');
    })

    // change the number of columns for graphs depending on number of sensors
    // e.g., if there is only one sensor, don't allow the 2 or 3 column layouts, so the graph is as large as possible
    if (sensors.length >= 1) {
        sensorList.addClass('row-cols-sm-1');
    }
    if (sensors.length >= 2) {
        sensorList.addClass('row-cols-md-2');
    }
    if (sensors.length >= 3) {
        sensorList.addClass('row-cols-xl-3');
    }

    txtRate(); // this needs to be first
    txtLength(); // read default values from the page

    clearCharts(charts);


</script>